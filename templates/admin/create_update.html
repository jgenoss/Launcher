{% extends "base.html" %}

{% block title %}Crear Paquete de Actualización - Launcher Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-download me-2"></i>Crear Paquete de Actualización
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin.updates') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver a Actualizaciones
        </a>
    </div>
</div>

<form method="POST" enctype="multipart/form-data" id="updateForm">
    <div class="row">
        <div class="col-lg-8">
            <!-- Version Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-tag me-2"></i>Seleccionar Versión
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <select class="form-select" name="version_id" id="versionSelect" required>
                                <option value="">Selecciona una versión...</option>
                                {% for version in versions %}
                                <option value="{{ version.id }}" 
                                        data-version="{{ version.version }}"
                                        data-latest="{{ version.is_latest }}"
                                        data-notes="{{ version.release_notes or '' }}">
                                    {{ version.version }}
                                    {% if version.is_latest %}- Versión Actual{% endif %}
                                    {% if version.update_packages %}(Ya tiene actualización){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Selecciona la versión para la cual crear el paquete de actualización</div>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.create_version') }}" class="btn btn-outline-primary w-100">
                                <i class="bi bi-plus-circle me-1"></i>Nueva Versión
                            </a>
                        </div>
                    </div>
                    
                    {% if not versions %}
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No hay versiones disponibles. 
                        <a href="{{ url_for('admin.create_version') }}" class="alert-link">Crea una versión</a> 
                        antes de crear un paquete de actualización.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- File Upload Area -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-zip me-2"></i>Archivo de Actualización
                    </h5>
                </div>
                <div class="card-body">
                    <div class="file-upload-area" id="uploadArea">
                        <div class="upload-content">
                            <i class="bi bi-file-zip" style="font-size: 3rem; color: #6c757d;"></i>
                            <h5 class="mt-3 mb-2">Arrastra un archivo ZIP aquí o haz clic para seleccionar</h5>
                            <p class="text-muted mb-3">
                                El archivo ZIP debe contener todos los archivos de la actualización<br>
                                con la estructura de directorios correcta
                            </p>
                            <button type="button" class="btn btn-primary" id="selectFileBtn">
                                <i class="bi bi-folder2-open me-2"></i>Seleccionar Archivo ZIP
                            </button>
                        </div>
                        <input type="file" 
                               id="updateFile" 
                               name="update_file" 
                               accept=".zip"
                               style="display: none;"
                               required>
                    </div>
                    
                    <!-- File Info -->
                    <div id="fileInfo" class="mt-4" style="display: none;">
                        <div class="alert alert-success">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-check-circle me-3"></i>
                                <div class="flex-grow-1">
                                    <strong>Archivo seleccionado:</strong><br>
                                    <span id="fileName" class="text-primary"></span><br>
                                    <small id="fileSize" class="text-muted"></small>
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFile()">
                                    <i class="bi bi-x"></i> Cambiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Update Options -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear me-2"></i>Opciones de Actualización
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="overwriteExisting" name="overwrite_existing" checked>
                                <label class="form-check-label" for="overwriteExisting">
                                    <strong>Sobrescribir archivos existentes</strong>
                                    <div class="form-text">Si está marcado, los archivos existentes serán reemplazados</div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="validateAfterUpload" name="validate_after_upload" checked>
                                <label class="form-check-label" for="validateAfterUpload">
                                    <strong>Validar después de subir</strong>
                                    <div class="form-text">Verificar integridad del archivo después de la subida</div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="generateMD5" name="generate_md5" checked>
                                <label class="form-check-label" for="generateMD5">
                                    <strong>Generar hash MD5</strong>
                                    <div class="form-text">Calcular automáticamente el hash MD5 del archivo</div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="updateJSON" name="update_json" checked>
                                <label class="form-check-label" for="updateJSON">
                                    <strong>Actualizar JSON automáticamente</strong>
                                    <div class="form-text">Regenerar el archivo update después de la subida</div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Progress -->
            <div class="card mb-4" id="progressCard" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-hourglass-split me-2"></i>Progreso de Subida
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="uploadProgress" 
                             style="width: 0%">0%</div>
                    </div>
                    <div id="uploadStatus" class="text-muted">
                        Preparando subida...
                    </div>
                    <div id="uploadDetails" class="small text-muted mt-2">
                        <!-- Upload details will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{{ url_for('admin.updates') }}" class="btn btn-outline-secondary me-md-2">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    <span class="btn-text">
                        <i class="bi bi-upload"></i> Crear Paquete de Actualización
                    </span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Version Information -->
            <div class="card mb-4" id="versionInfoCard" style="display: none;">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Información de la Versión
                    </h6>
                </div>
                <div class="card-body" id="versionInfo">
                    <!-- Version info will be loaded here -->
                </div>
            </div>

            <!-- Upload Guidelines -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-list-check me-2"></i>Guía de Actualización
                    </h6>
                </div>
                <div class="card-body">
                    <div class="update-guidelines">
                        <h6 class="fw-bold">Estructura del ZIP:</h6>
                        <ul class="list-unstyled mb-3">
                            <li><i class="bi bi-check text-success me-2"></i>Mantén la estructura de directorios</li>
                            <li><i class="bi bi-check text-success me-2"></i>Incluye solo archivos modificados</li>
                            <li><i class="bi bi-check text-success me-2"></i>Usa rutas relativas</li>
                        </ul>

                        <h6 class="fw-bold">Archivos Recomendados:</h6>
                        <ul class="list-unstyled mb-3">
                            <li><i class="bi bi-file-earmark text-primary me-2"></i>Ejecutables (.exe)</li>
                            <li><i class="bi bi-file-earmark text-secondary me-2"></i>Librerías (.dll)</li>
                            <li><i class="bi bi-file-earmark text-info me-2"></i>Configuración (.xml, )</li>
                            <li><i class="bi bi-file-earmark text-success me-2"></i>Recursos (imágenes, sonidos)</li>
                        </ul>

                        <h6 class="fw-bold">Consideraciones:</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-exclamation-triangle text-warning me-2"></i>Tamaño máximo: 500 MB</li>
                            <li><i class="bi bi-shield-check text-success me-2"></i>Se calculará MD5 automáticamente</li>
                            <li><i class="bi bi-arrow-repeat text-info me-2"></i>Se puede reemplazar si ya existe</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Example Structure -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-folder me-2"></i>Ejemplo de Estructura
                    </h6>
                </div>
                <div class="card-body">
                    <div class="example-structure">
                        <pre class="small text-muted mb-0">
                            <code>
                                update_1.0.0.1.zip
                                ├── bin/
                                │   ├── Nksp.exe
                                │   ├── GameEngine.dll
                                │   └── config.xml
                                ├── assets/
                                │   ├── textures/
                                │   └── sounds/
                                └── README.txt
                            </code>
                        </pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_css %}
<style>
.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    padding: 3rem 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.file-upload-area.dragover {
    border-color: #0d6efd;
    background-color: #e7f3ff;
}

.file-upload-area.file-selected {
    border-color: #198754;
    background-color: #f8fff9;
}

.file-upload-area.file-selected h5 {
    color: #198754;
}

.update-guidelines ul li {
    margin-bottom: 0.5rem;
}

.example-structure {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    let selectedFile = null;
    
    // Function to handle file selection button click
    function selectFileButtonClick() {
        console.log('Select file button clicked');
        const fileInput = document.getElementById('updateFile');
        if (fileInput) {
            console.log('File input found, triggering click');
            // Force focus and click
            fileInput.focus();
            fileInput.click();
        } else {
            console.error('File input not found');
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Initializing create update form...');
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('updateFile');
        const versionSelect = document.getElementById('versionSelect');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('updateForm');
        
        // Check if required elements exist and log their status
        console.log('Upload area found:', !!uploadArea);
        console.log('File input found:', !!fileInput);
        console.log('Version select found:', !!versionSelect);
        console.log('Submit button found:', !!submitBtn);
        console.log('Form found:', !!form);
        
        // Add event listeners only to existing elements
        if (uploadArea && fileInput) {
            // Remove any existing event listeners
            uploadArea.replaceWith(uploadArea.cloneNode(true));
            const newUploadArea = document.getElementById('uploadArea');
            
            // File upload area click with proper event handling
            newUploadArea.addEventListener('click', function(e) {
                // Don't prevent default for button clicks
                if (e.target.tagName !== 'BUTTON') {
                    e.preventDefault();
                }
                e.stopPropagation();
                console.log('Upload area clicked - triggering file input');
                
                // Create a new click event to ensure it works
                setTimeout(function() {
                    fileInput.click();
                }, 10);
            });
            
            // Drag and drop events
            newUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                newUploadArea.classList.add('dragover');
            });
            
            newUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                newUploadArea.classList.remove('dragover');
            });
            
            newUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                newUploadArea.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                const zipFile = files.find(file => file.name.toLowerCase().endsWith('.zip'));
                
                if (zipFile) {
                    handleFileSelection(zipFile);
                } else {
                    alert('Por favor selecciona un archivo ZIP válido');
                }
            });
        }
        
        // Button click handler
        const selectFileBtn = document.getElementById('selectFileBtn');
        if (selectFileBtn && fileInput) {
            selectFileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Select file button clicked via event listener');
                fileInput.click();
            });
        }
        
        if (fileInput) {
            // File input change
            fileInput.addEventListener('change', function(e) {
                console.log('File input changed');
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });
        }
        
        if (versionSelect) {
            // Version selection change
            versionSelect.addEventListener('change', function() {
                const versionInfoCard = document.getElementById('versionInfoCard');
                if (this.value) {
                    loadVersionInfo(this.value);
                } else {
                    if (versionInfoCard) {
                        versionInfoCard.style.display = 'none';
                    }
                }
                updateSubmitButton();
            });
        }
        
        if (form) {
            // Form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submission prevented, calling submitUpdate');
                submitUpdate();
            });
        }
        
        if (submitBtn) {
            // Direct button click handler as backup
            submitBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Submit button clicked directly');
                if (!submitBtn.disabled) {
                    submitUpdate();
                }
            });
        }
        
        // Load version info if pre-selected
        const urlParams = new URLSearchParams(window.location.search);
        const versionId = urlParams.get('version_id');
        if (versionId && versionSelect) {
            versionSelect.value = versionId;
            loadVersionInfo(versionId);
        }
        
        // Initial button state update
        updateSubmitButton();
        
        console.log('Initialization completed successfully');
    });
    
    function handleFileSelection(file) {
        console.log('File selected:', file.name, 'Size:', file.size);
        
        if (!file.name.toLowerCase().endsWith('.zip')) {
            alert('Solo se permiten archivos ZIP');
            return;
        }
        
        selectedFile = file;
        
        // Update the file input to reflect the selection
        const fileInput = document.getElementById('updateFile');
        if (fileInput && fileInput.files.length === 0) {
            // Create a new FileList with our file
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }
        
        // Show file info with better error handling
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileInfo = document.getElementById('fileInfo');
        
        console.log('Looking for elements:', {
            fileName: !!fileName,
            fileSize: !!fileSize,
            fileInfo: !!fileInfo
        });
        
        if (fileName) {
            fileName.textContent = file.name;
            console.log('File name set to:', file.name);
        } else {
            console.error('fileName element not found in DOM');
        }
        
        if (fileSize) {
            const sizeText = formatFileSize(file.size);
            fileSize.textContent = sizeText;
            console.log('File size set to:', sizeText);
        } else {
            console.error('fileSize element not found in DOM');
        }
        
        if (fileInfo) {
            fileInfo.style.display = 'block';
            console.log('File info shown');
        } else {
            console.error('fileInfo element not found in DOM');
        }
        
        // Also update the upload area to show file is selected
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
            uploadArea.classList.add('file-selected');
            uploadArea.querySelector('.upload-content h5').textContent = `Archivo seleccionado: ${file.name}`;
        }
        
        updateSubmitButton();
        console.log('File selection completed successfully');
    }
    
    function clearFile() {
        selectedFile = null;
        const fileInput = document.getElementById('updateFile');
        const fileInfo = document.getElementById('fileInfo');
        
        if (fileInput) fileInput.value = '';
        if (fileInfo) fileInfo.style.display = 'none';
        updateSubmitButton();
    }
    
    function loadVersionInfo(versionId) {
        const versionOption = document.querySelector(`option[value="${versionId}"]`);
        if (!versionOption) return;
        
        const version = versionOption.dataset.version;
        const isLatest = versionOption.dataset.latest === 'true';
        const notes = versionOption.dataset.notes;
        
        const versionInfoCard = document.getElementById('versionInfoCard');
        const versionInfo = document.getElementById('versionInfo');
        
        if (versionInfoCard && versionInfo) {
            versionInfoCard.style.display = 'block';
            versionInfo.innerHTML = `
                <dl class="row mb-0">
                    <dt class="col-sm-5">Versión:</dt>
                    <dd class="col-sm-7">
                        <span class="badge ${isLatest ? 'bg-success' : 'bg-secondary'}">${version}</span>
                    </dd>
                    <dt class="col-sm-5">Estado:</dt>
                    <dd class="col-sm-7">${isLatest ? 'Actual' : 'Archivada'}</dd>
                    <dt class="col-sm-5">Archivo sugerido:</dt>
                    <dd class="col-sm-7"><code>update_${version}.zip</code></dd>
                </dl>
                ${notes ? `
                    <hr class="my-3">
                    <h6 class="fw-bold">Notas:</h6>
                    <div class="bg-light p-2 rounded small">${notes}</div>
                ` : ''}
            `;
        }
    }
    
    function updateSubmitButton() {
        const submitBtn = document.getElementById('submitBtn');
        const versionSelect = document.getElementById('versionSelect');
        
        if (!submitBtn || !versionSelect) return;
        
        const hasFile = selectedFile !== null;
        const hasVersion = versionSelect.value !== '';
        
        submitBtn.disabled = !(hasFile && hasVersion);
    }
    
    async function submitUpdate() {
        console.log('submitUpdate called');
        console.log('Selected file:', selectedFile);
        
        if (!selectedFile) {
            alert('Selecciona un archivo ZIP');
            return;
        }
        
        const versionSelect = document.getElementById('versionSelect');
        if (!versionSelect || !versionSelect.value) {
            alert('Selecciona una versión');
            return;
        }
        
        const versionId = versionSelect.value;
        console.log('Version ID:', versionId);
        
        // Show progress with null checks
        const progressCard = document.getElementById('progressCard');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadDetails = document.getElementById('uploadDetails');
        const submitBtn = document.getElementById('submitBtn');
        
        if (progressCard) progressCard.style.display = 'block';
        if (submitBtn) submitBtn.disabled = true;
        
        // Show loading on button
        const btnText = submitBtn ? submitBtn.querySelector('.btn-text') : null;
        const spinner = submitBtn ? submitBtn.querySelector('.spinner-border') : null;
        
        if (btnText) btnText.innerHTML = '<i class="bi bi-hourglass"></i> Procesando...';
        if (spinner) spinner.classList.remove('d-none');
        
        try {
            const formData = new FormData();
            formData.append('version_id', versionId);
            formData.append('update_file', selectedFile);
            
            console.log('FormData created with:', {
                version_id: versionId,
                update_file: selectedFile.name
            });
            
            const checkboxes = [
                'overwriteExisting',
                'validateAfterUpload', 
                'generateMD5',
                'updateJSON'
            ];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    const fieldName = id.replace(/([A-Z])/g, '_$1').toLowerCase();
                    formData.append(fieldName, checkbox.checked);
                    console.log(`Checkbox ${fieldName}:`, checkbox.checked);
                }
            });
            
            // Simulate upload progress
            let progress = 0;
            if (uploadStatus) uploadStatus.textContent = 'Subiendo archivo...';
            if (uploadDetails) uploadDetails.textContent = `Archivo: ${selectedFile.name} (${formatFileSize(selectedFile.size)})`;
            
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 85) progress = 85;
                
                if (uploadProgress) {
                    uploadProgress.style.width = `${progress}%`;
                    uploadProgress.textContent = `${Math.round(progress)}%`;
                }
            }, 300);
            
            console.log('Sending request to:', window.location.href);
            
            // Submit form
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });
            
            clearInterval(progressInterval);
            console.log('Response status:', response.status);
            
            if (response.ok) {
                // Complete progress
                if (uploadProgress) {
                    uploadProgress.style.width = '100%';
                    uploadProgress.textContent = '100%';
                    uploadProgress.classList.remove('progress-bar-animated');
                    uploadProgress.classList.add('bg-success');
                }
                if (uploadStatus) {
                    uploadStatus.innerHTML = '<i class="bi bi-check-circle text-success me-2"></i>¡Paquete creado exitosamente!';
                }
                if (uploadDetails) {
                    uploadDetails.innerHTML = 'Redirigiendo a la página de actualizaciones...';
                }
                
                setTimeout(() => {
                    window.location.href = '/admin/updates';
                }, 2000);
            } else {
                const responseText = await response.text();
                console.error('Server response:', responseText);
                throw new Error(`Error del servidor: ${response.status}`);
            }
            
        } catch (error) {
            console.error('Submit error:', error);
            if (uploadProgress) {
                uploadProgress.classList.remove('progress-bar-animated');
                uploadProgress.classList.add('bg-danger');
            }
            if (uploadStatus) {
                uploadStatus.innerHTML = `<i class="bi bi-exclamation-triangle text-danger me-2"></i>Error: ${error.message}`;
            }
            if (uploadDetails) {
                uploadDetails.textContent = 'La subida ha fallado. Revisa la consola para más detalles.';
            }
            
            // Restore button
            if (btnText) btnText.innerHTML = '<i class="bi bi-upload"></i> Crear Paquete de Actualización';
            if (spinner) spinner.classList.add('d-none');
            if (submitBtn) submitBtn.disabled = false;
        }
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
</script>
{% endblock %}