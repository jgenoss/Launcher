{% extends "base.html" %}

{% block title %}Subir Nueva Versión del Launcher - Launcher Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-cloud-upload me-2"></i>Subir Nueva Versión del Launcher
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin.launcher_versions') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver al Launcher
        </a>
    </div>
</div>

<form method="POST" enctype="multipart/form-data" id="launcherForm">
    <div class="row">
        <div class="col-lg-8">
            <!-- Version Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Información de la Versión
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" 
                                       class="form-control" 
                                       id="version" 
                                       name="version" 
                                       placeholder="1.0.0.0" 
                                       pattern="^\d+\.\d+\.\d+\.\d+$"
                                       required>
                                <label for="version">
                                    <i class="bi bi-tag me-2"></i>Número de Versión
                                </label>
                                <div class="form-text">Formato: 1.0.0.0 (Mayor.Menor.Parche.Build)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="is_current" 
                                       name="is_current"
                                       checked>
                                <label class="form-check-label" for="is_current">
                                    <i class="bi bi-star me-2"></i>Establecer como versión actual
                                </label>
                                <div class="form-text">Los clientes descargarán esta versión automáticamente</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating mb-3">
                        <textarea class="form-control" 
                                  id="release_notes" 
                                  name="release_notes" 
                                  placeholder="Descripción de los cambios..."
                                  style="height: 120px;"></textarea>
                        <label for="release_notes">
                            <i class="bi bi-journal-text me-2"></i>Notas de la Versión
                        </label>
                        <div class="form-text">Describe los cambios, mejoras y correcciones de esta versión</div>
                    </div>
                </div>
            </div>

            <!-- File Upload Area -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-code me-2"></i>Archivo del Launcher
                    </h5>
                </div>
                <div class="card-body">
                    <div class="file-upload-area" id="uploadArea">
                        <div class="upload-content">
                            <i class="bi bi-app" style="font-size: 3rem; color: #6c757d;"></i>
                            <h5 class="mt-3 mb-2">Arrastra el ejecutable aquí o haz clic para seleccionar</h5>
                            <p class="text-muted mb-3">
                                Solo archivos .exe son permitidos<br>
                                El archivo será renombrado automáticamente si es necesario
                            </p>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('launcherFile').click()">
                                <i class="bi bi-folder2-open me-2"></i>Seleccionar Ejecutable
                            </button>
                        </div>
                        <input type="file" 
                               id="launcherFile" 
                               name="launcher_file" 
                               accept=".exe"
                               style="display: none;"
                               required>
                    </div>
                    
                    <!-- File Info -->
                    <div id="fileInfo" class="mt-4" style="display: none;">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-info-circle me-3"></i>
                                <div class="flex-grow-1">
                                    <strong id="fileName"></strong><br>
                                    <small id="fileSize"></small>
                                    <div class="mt-2">
                                        <strong>Nombre final:</strong> <code id="finalFileName"></code>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFile()">
                                    <i class="bi bi-x"></i> Cambiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear me-2"></i>Opciones Avanzadas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="replaceExisting" name="replace_existing" checked>
                                <label class="form-check-label" for="replaceExisting">
                                    <strong>Reemplazar si existe</strong>
                                    <div class="form-text">Sobrescribir si ya existe una versión con el mismo número</div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="createBackup" name="create_backup" checked>
                                <label class="form-check-label" for="createBackup">
                                    <strong>Crear backup de la versión actual</strong>
                                    <div class="form-text">Respaldar la versión actual antes de reemplazarla</div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="updateJSON" name="update_json" checked>
                                <label class="form-check-label" for="updateJSON">
                                    <strong>Actualizar JSON automáticamente</strong>
                                    <div class="form-text">Regenerar launcher_update.json después de la subida</div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="notifyClients" name="notify_clients">
                                <label class="form-check-label" for="notifyClients">
                                    <strong>Notificar a clientes</strong>
                                    <div class="form-text">Enviar notificación de nueva versión disponible</div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Progress -->
            <div class="card mb-4" id="progressCard" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-hourglass-split me-2"></i>Progreso de Subida
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="uploadProgress" 
                             style="width: 0%">0%</div>
                    </div>
                    <div id="uploadStatus" class="text-muted">
                        Preparando subida...
                    </div>
                    <div id="uploadSteps" class="small text-muted mt-2">
                        <!-- Upload steps will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{{ url_for('admin.launcher_versions') }}" class="btn btn-outline-secondary me-md-2">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    <span class="btn-text">
                        <i class="bi bi-cloud-upload"></i> Subir Launcher
                    </span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Version Preview -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-eye me-2"></i>Vista Previa
                    </h6>
                </div>
                <div class="card-body">
                    <div class="launcher-preview">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-app text-primary me-2"></i>
                            <strong id="previewVersion">1.0.0.0</strong>
                            <span class="badge bg-success ms-2" id="previewBadge">Actual</span>
                        </div>
                        <div class="text-muted small mb-2" id="previewDate">
                            Fecha: <span id="currentDate"></span>
                        </div>
                        <div class="text-muted small mb-3" id="previewFile">
                            Archivo: <code id="previewFileName">Launcher.exe</code>
                        </div>
                        <div class="mt-3">
                            <strong>Notas:</strong>
                            <div class="bg-light p-2 rounded mt-1" id="previewNotes">
                                <em class="text-muted">Sin notas...</em>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Guidelines -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Guía de Subida
                    </h6>
                </div>
                <div class="card-body">
                    <div class="launcher-guidelines">
                        <h6 class="fw-bold">Requisitos del Archivo:</h6>
                        <ul class="list-unstyled mb-3">
                            <li><i class="bi bi-check text-success me-2"></i>Archivo ejecutable (.exe)</li>
                            <li><i class="bi bi-check text-success me-2"></i>Compilado para Windows</li>
                            <li><i class="bi bi-check text-success me-2"></i>Probado y funcional</li>
                        </ul>

                        <h6 class="fw-bold">Convención de Nombres:</h6>
                        <ul class="list-unstyled mb-3">
                            <li><i class="bi bi-file-code text-primary me-2"></i>LC.exe (recomendado)</li>
                            <li><i class="bi bi-file-code text-primary me-2"></i>Launcher.exe</li>
                            <li><i class="bi bi-file-code text-primary me-2"></i>GameLauncher.exe</li>
                        </ul>

                        <h6 class="fw-bold">Proceso de Subida:</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-1-circle text-info me-2"></i>Validación del archivo</li>
                            <li><i class="bi bi-2-circle text-info me-2"></i>Backup de versión actual</li>
                            <li><i class="bi bi-3-circle text-info me-2"></i>Subida del nuevo archivo</li>
                            <li><i class="bi bi-4-circle text-info me-2"></i>Actualización de metadatos</li>
                            <li><i class="bi bi-5-circle text-info me-2"></i>Regeneración de JSON</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Current Version Info -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-star me-2"></i>Versión Actual
                    </h6>
                </div>
                <div class="card-body">
                    <div id="currentVersionInfo">
                        <!-- Current version info will be loaded here -->
                        <div class="text-muted text-center">
                            <i class="bi bi-app" style="font-size: 2rem;"></i>
                            <br>
                            <small>Cargando información...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
    let selectedFile = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('launcherFile');
        const versionInput = document.getElementById('version');
        const notesInput = document.getElementById('release_notes');
        const isCurrentInput = document.getElementById('is_current');
        const form = document.getElementById('launcherForm');
        
        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-ES');
        
        // Load current version info
        loadCurrentVersionInfo();
        
        // File upload area events
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            const exeFile = files.find(file => file.name.toLowerCase().endsWith('.exe'));
            
            if (exeFile) {
                handleFileSelection(exeFile);
            } else {
                alert('Por favor selecciona un archivo ejecutable (.exe)');
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });
        
        // Live preview updates
        versionInput.addEventListener('input', function() {
            const version = this.value || '1.0.0.0';
            document.getElementById('previewVersion').textContent = version;
        });
        
        notesInput.addEventListener('input', function() {
            const notes = this.value.trim();
            const previewNotes = document.getElementById('previewNotes');
            
            if (notes) {
                previewNotes.innerHTML = notes.replace(/\n/g, '<br>');
                previewNotes.className = 'bg-light p-2 rounded mt-1';
            } else {
                previewNotes.innerHTML = '<em class="text-muted">Sin notas...</em>';
                previewNotes.className = 'bg-light p-2 rounded mt-1';
            }
        });
        
        isCurrentInput.addEventListener('change', function() {
            const badge = document.getElementById('previewBadge');
            if (this.checked) {
                badge.textContent = 'Actual';
                badge.className = 'badge bg-success ms-2';
            } else {
                badge.textContent = 'Archivada';
                badge.className = 'badge bg-secondary ms-2';
            }
        });
        
        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            submitLauncher();
        });
        
        // Version input validation
        versionInput.addEventListener('blur', function() {
            let version = this.value.trim();
            if (version && !/^\d+\.\d+\.\d+\.\d+$/.test(version)) {
                const parts = version.split('.');
                while (parts.length < 4) {
                    parts.push('0');
                }
                this.value = parts.slice(0, 4).join('.');
                this.dispatchEvent(new Event('input'));
            }
        });
        
        // Focus on version input
        versionInput.focus();
    });
    
    function handleFileSelection(file) {
        if (!file.name.toLowerCase().endsWith('.exe')) {
            alert('Solo se permiten archivos ejecutables (.exe)');
            return;
        }
        
        selectedFile = file;
        
        // Generate final filename
        const version = document.getElementById('version').value || 'latest';
        const finalName = 'LC.exe'; // You could customize this based on settings
        
        // Show file info
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        document.getElementById('finalFileName').textContent = finalName;
        document.getElementById('fileInfo').style.display = 'block';
        
        // Update preview
        document.getElementById('previewFileName').textContent = finalName;
        
        updateSubmitButton();
    }
    
    function clearFile() {
        selectedFile = null;
        document.getElementById('launcherFile').value = '';
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('previewFileName').textContent = 'Launcher.exe';
        updateSubmitButton();
    }
    
    function updateSubmitButton() {
        const submitBtn = document.getElementById('submitBtn');
        const versionInput = document.getElementById('version');
        
        const hasFile = selectedFile !== null;
        const hasVersion = versionInput.value.trim() !== '';
        const validVersion = /^\d+\.\d+\.\d+\.\d+$/.test(versionInput.value.trim());
        
        submitBtn.disabled = !(hasFile && hasVersion && validVersion);
    }
    
    async function loadCurrentVersionInfo() {
        try {
            const response = await fetch('/api/launcher_update.json');
            const data = await response.json();
            
            const currentVersionInfo = document.getElementById('currentVersionInfo');
            currentVersionInfo.innerHTML = `
                <div class="text-center">
                    <h6 class="text-success mb-2">${data.version}</h6>
                    <p class="mb-2"><code>${data.file_name}</code></p>
                    <small class="text-muted">En producción</small>
                </div>
                <hr>
                <div class="d-grid">
                    <a href="/Launcher/${data.file_name}" class="btn btn-outline-primary btn-sm" target="_blank">
                        <i class="bi bi-download me-1"></i>Descargar Actual
                    </a>
                </div>
            `;
        } catch (error) {
            const currentVersionInfo = document.getElementById('currentVersionInfo');
            currentVersionInfo.innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    <br>
                    <small>No hay versión actual</small>
                </div>
            `;
        }
    }
    
    async function submitLauncher() {
        if (!selectedFile) {
            alert('Selecciona un archivo ejecutable');
            return;
        }
        
        const versionInput = document.getElementById('version');
        const version = versionInput.value.trim();
        
        if (!version || !/^\d+\.\d+\.\d+\.\d+$/.test(version)) {
            alert('Ingresa una versión válida (formato: 1.0.0.0)');
            versionInput.focus();
            return;
        }
        
        // Show progress
        const progressCard = document.getElementById('progressCard');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadSteps = document.getElementById('uploadSteps');
        const submitBtn = document.getElementById('submitBtn');
        
        progressCard.style.display = 'block';
        submitBtn.disabled = true;
        
        // Show loading on button
        const btnText = submitBtn.querySelector('.btn-text');
        const spinner = submitBtn.querySelector('.spinner-border');
        btnText.innerHTML = '<i class="bi bi-hourglass"></i> Procesando...';
        spinner.classList.remove('d-none');
        
        try {
            const formData = new FormData();
            formData.append('version', version);
            formData.append('launcher_file', selectedFile);
            formData.append('release_notes', document.getElementById('release_notes').value);
            formData.append('is_current', document.getElementById('is_current').checked);
            formData.append('replace_existing', document.getElementById('replaceExisting').checked);
            formData.append('create_backup', document.getElementById('createBackup').checked);
            formData.append('update_json', document.getElementById('updateJSON').checked);
            formData.append('notify_clients', document.getElementById('notifyClients').checked);
            
            // Simulate upload steps
            const steps = [
                'Validando archivo...',
                'Creando backup de versión actual...',
                'Subiendo nuevo launcher...',
                'Actualizando metadatos...',
                'Regenerando JSON de configuración...',
                'Finalizando...'
            ];
            
            let progress = 0;
            let stepIndex = 0;
            
            const progressInterval = setInterval(() => {
                if (stepIndex < steps.length) {
                    uploadStatus.textContent = steps[stepIndex];
                    uploadSteps.innerHTML = steps.slice(0, stepIndex + 1)
                        .map((step, i) => `<div>${i === stepIndex ? '🔄' : '✅'} ${step}</div>`)
                        .join('');
                    stepIndex++;
                }
                
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                
                uploadProgress.style.width = `${progress}%`;
                uploadProgress.textContent = `${Math.round(progress)}%`;
            }, 1000);
            
            // Submit form
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });
            
            clearInterval(progressInterval);
            
            if (response.ok) {
                // Complete progress
                uploadProgress.style.width = '100%';
                uploadProgress.textContent = '100%';
                uploadStatus.innerHTML = '<i class="bi bi-check-circle text-success me-2"></i>¡Launcher subido exitosamente!';
                uploadSteps.innerHTML = steps.map(step => `<div>✅ ${step}</div>`).join('');
                
                setTimeout(() => {
                    window.location.href = '{{ url_for("admin.launcher_versions") }}';
                }, 2000);
            } else {
                throw new Error(`Error del servidor: ${response.status}`);
            }
            
        } catch (error) {
            uploadProgress.classList.remove('progress-bar-animated');
            uploadProgress.classList.add('bg-danger');
            uploadStatus.innerHTML = `<i class="bi bi-exclamation-triangle text-danger me-2"></i>Error: ${error.message}`;
            uploadSteps.innerHTML = '<div class="text-danger">❌ La subida ha fallado</div>';
            
            // Restore button
            btnText.innerHTML = '<i class="bi bi-cloud-upload"></i> Subir Launcher';
            spinner.classList.add('d-none');
            submitBtn.disabled = false;
        }
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    // Update submit button on input changes
    document.addEventListener('input', function(e) {
        if (e.target.id === 'version') {
            updateSubmitButton();
        }
    });
</script>
{% endblock %}