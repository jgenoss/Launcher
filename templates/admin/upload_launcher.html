{% extends "base.html" %}

{% block title %}Subir Nueva Versi√≥n del Launcher - Launcher Admin Panel{% endblock %}

{% block content %}
<style>
    .file-upload-area.file-selected {
        border-color: #198754;
        background-color: #f8fff9;
    }

    .file-upload-area.file-selected h5 {
        color: #198754 !important;
    }
</style>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-cloud-upload me-2"></i>Subir Nueva Versi√≥n del Launcher
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin.launcher_versions') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver al Launcher
        </a>
    </div>
</div>

<form method="POST" enctype="multipart/form-data" id="launcherForm">
    <div class="row">
        <div class="col-lg-8">
            <!-- Version Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Informaci√≥n de la Versi√≥n
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="version" name="version"
                                    placeholder="1.0.0.0" pattern="^\d+\.\d+\.\d+\.\d+$" required>
                                <label for="version">
                                    <i class="bi bi-tag me-2"></i>N√∫mero de Versi√≥n
                                </label>
                                <div class="form-text">Formato: 1.0.0.0 (Mayor.Menor.Parche.Build)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="is_current" name="is_current"
                                    checked>
                                <label class="form-check-label" for="is_current">
                                    <i class="bi bi-star me-2"></i>Establecer como versi√≥n actual
                                </label>
                                <div class="form-text">Los clientes descargar√°n esta versi√≥n autom√°ticamente</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="release_notes" name="release_notes"
                            placeholder="Descripci√≥n de los cambios..." style="height: 120px;"></textarea>
                        <label for="release_notes">
                            <i class="bi bi-journal-text me-2"></i>Notas de la Versi√≥n
                        </label>
                        <div class="form-text">Describe los cambios, mejoras y correcciones de esta versi√≥n</div>
                    </div>
                </div>
            </div>

            <!-- File Upload Area -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-code me-2"></i>Archivo del Launcher
                    </h5>
                </div>
                <div class="card-body">
                    <div class="file-upload-area" id="uploadArea">
                        <div class="upload-content">
                            <i class="bi bi-filetype-exe" style="font-size: 3rem; color: #6c757d;"></i>
                            <h5 class="mt-3 mb-2">Arrastra el ejecutable aqu√≠ o haz clic para seleccionar</h5>
                            <p class="text-muted mb-3">
                                Solo archivos .exe son permitidos<br>
                                El archivo ser√° renombrado autom√°ticamente si es necesario
                            </p>
                            <button type="button" class="btn btn-primary">
                                <i class="bi bi-folder2-open me-2"></i>Seleccionar Ejecutable
                            </button>
                        </div>
                        <input type="file" id="launcherFile" name="launcher_file" accept=".exe" style="display: none;"
                            required>
                    </div>

                    <!-- File Info -->
                    <div id="fileInfo" class="mt-4" style="display: none;">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-info-circle me-3"></i>
                                <div class="flex-grow-1">
                                    <strong id="fileName"></strong><br>
                                    <small id="fileSize"></small>
                                    <div class="mt-2">
                                        <strong>Nombre final:</strong> <code id="finalFileName"></code>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFile()">
                                    <i class="bi bi-x"></i> Cambiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear me-2"></i>Opciones Avanzadas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="replaceExisting"
                                    name="replace_existing" checked>
                                <label class="form-check-label" for="replaceExisting">
                                    <strong>Reemplazar si existe</strong>
                                    <div class="form-text">Sobrescribir si ya existe una versi√≥n con el mismo n√∫mero
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="createBackup" name="create_backup"
                                    checked>
                                <label class="form-check-label" for="createBackup">
                                    <strong>Crear backup de la versi√≥n actual</strong>
                                    <div class="form-text">Respaldar la versi√≥n actual antes de reemplazarla</div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="updateJSON" name="update_json"
                                    checked>
                                <label class="form-check-label" for="updateJSON">
                                    <strong>Actualizar JSON autom√°ticamente</strong>
                                    <div class="form-text">Regenerar launcher_update despu√©s de la subida</div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="notifyClients"
                                    name="notify_clients">
                                <label class="form-check-label" for="notifyClients">
                                    <strong>Notificar a clientes</strong>
                                    <div class="form-text">Enviar notificaci√≥n de nueva versi√≥n disponible</div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Progress -->
            <div class="card mb-4" id="progressCard" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-hourglass-split me-2"></i>Progreso de Subida
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                            id="uploadProgress" style="width: 0%">0%</div>
                    </div>
                    <div id="uploadStatus" class="text-muted">
                        Preparando subida...
                    </div>
                    <div id="uploadSteps" class="small text-muted mt-2">
                        <!-- Upload steps will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{{ url_for('admin.launcher_versions') }}" class="btn btn-outline-secondary me-md-2">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    <span class="btn-text">
                        <i class="bi bi-cloud-upload"></i> Subir Launcher
                    </span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Version Preview -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-eye me-2"></i>Vista Previa
                    </h6>
                </div>
                <div class="card-body">
                    <div class="launcher-preview">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-filetype-exe text-primary me-2"></i>
                            <strong id="previewVersion">1.0.0.0</strong>
                            <span class="badge bg-success ms-2" id="previewBadge">Actual</span>
                        </div>
                        <div class="text-muted small mb-2" id="previewDate">
                            Fecha: <span id="currentDate"></span>
                        </div>
                        <div class="text-muted small mb-3" id="previewFile">
                            Archivo: <code id="previewFileName">Launcher.exe</code>
                        </div>
                        <div class="mt-3">
                            <strong>Notas:</strong>
                            <div class="bg-light p-2 rounded mt-1" id="previewNotes">
                                <em class="text-muted">Sin notas...</em>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Guidelines -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Gu√≠a de Subida
                    </h6>
                </div>
                <div class="card-body">
                    <div class="launcher-guidelines">
                        <h6 class="fw-bold">Requisitos del Archivo:</h6>
                        <ul class="list-unstyled mb-3">
                            <li><i class="bi bi-check text-success me-2"></i>Archivo ejecutable (.exe)</li>
                            <li><i class="bi bi-check text-success me-2"></i>Compilado para Windows</li>
                            <li><i class="bi bi-check text-success me-2"></i>Probado y funcional</li>
                        </ul>

                        <h6 class="fw-bold">Convenci√≥n de Nombres:</h6>
                        <ul class="list-unstyled mb-3">
                            <li><i class="bi bi-file-code text-primary me-2"></i>LC.exe (recomendado)</li>
                            <li><i class="bi bi-file-code text-primary me-2"></i>Launcher.exe</li>
                            <li><i class="bi bi-file-code text-primary me-2"></i>GameLauncher.exe</li>
                        </ul>

                        <h6 class="fw-bold">Proceso de Subida:</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-1-circle text-info me-2"></i>Validaci√≥n del archivo</li>
                            <li><i class="bi bi-2-circle text-info me-2"></i>Backup de versi√≥n actual</li>
                            <li><i class="bi bi-3-circle text-info me-2"></i>Subida del nuevo archivo</li>
                            <li><i class="bi bi-4-circle text-info me-2"></i>Actualizaci√≥n de metadatos</li>
                            <li><i class="bi bi-5-circle text-info me-2"></i>Regeneraci√≥n de JSON</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Current Version Info -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-star me-2"></i>Versi√≥n Actual
                    </h6>
                </div>
                <div class="card-body">
                    <div id="currentVersionInfo">
                        <!-- Current version info will be loaded here -->
                        <div class="text-muted text-center">
                            <i class="bi bi-filetype-exe" style="font-size: 2rem;"></i>
                            <br>
                            <small>Cargando informaci√≥n...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
    let selectedFile = null;

    document.addEventListener('DOMContentLoaded', function () {
        console.log('Inicializando upload launcher...');

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('launcherFile');
        const versionInput = document.getElementById('version');
        const notesInput = document.getElementById('release_notes');
        const isCurrentInput = document.getElementById('is_current');
        const form = document.getElementById('launcherForm');


        // Verificar elementos cr√≠ticos
        console.log('Elementos encontrados:', {
            uploadArea: !!uploadArea,
            fileInput: !!fileInput,
            versionInput: !!versionInput,
            form: !!form
        });

        // Set current date SOLO si el elemento existe
        const currentDateEl = document.getElementById('currentDate');
        if (currentDateEl) {
            currentDateEl.textContent = new Date().toLocaleDateString('es-ES');
        } else {
            console.warn('Elemento currentDate no encontrado');
        }

        // Load current version info
        loadCurrentVersionInfo();

        // File upload area events - SOLO si existen los elementos
        if (uploadArea && fileInput) {
            uploadArea.addEventListener('click', (e) => {
                // üéØ PREVENIR doble disparo si se hace click en el bot√≥n
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return; // No hacer nada si el click fue en el bot√≥n
                }
                fileInput.click();
            });

            // üéØ CONFIGURAR el bot√≥n por separado
            const selectButton = uploadArea.querySelector('.btn');
            if (selectButton) {
                selectButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evitar que se propague al √°rea
                    fileInput.click();
                });
            }


            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                const files = Array.from(e.dataTransfer.files);
                const exeFile = files.find(file => file.name.toLowerCase().endsWith('.exe'));

                if (exeFile) {
                    handleFileSelection(exeFile);
                } else {
                    alert('Por favor selecciona un archivo ejecutable (.exe)');
                }
            });

            fileInput.addEventListener('change', (e) => {
                console.log('File input changed, files:', e.target.files.length);
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });
        } else {
            console.error('Upload area o file input no encontrados');
        }

        // Live preview updates - SOLO si existen los elementos
        if (versionInput) {
            versionInput.addEventListener('input', function () {
                const version = this.value || '1.0.0.0';
                const previewVersionEl = document.getElementById('previewVersion');
                if (previewVersionEl) {
                    previewVersionEl.textContent = version;
                }
            });

            // Version input validation
            versionInput.addEventListener('blur', function () {
                let version = this.value.trim();
                if (version && !/^\d+\.\d+\.\d+\.\d+$/.test(version)) {
                    const parts = version.split('.');
                    while (parts.length < 4) {
                        parts.push('0');
                    }
                    this.value = parts.slice(0, 4).join('.');
                    this.dispatchEvent(new Event('input'));
                }
            });

            // Focus on version input
            versionInput.focus();
        }

        if (notesInput) {
            notesInput.addEventListener('input', function () {
                const notes = this.value.trim();
                const previewNotes = document.getElementById('previewNotes');

                if (previewNotes) {
                    if (notes) {
                        previewNotes.innerHTML = notes.replace(/\n/g, '<br>');
                        previewNotes.className = 'bg-light p-2 rounded mt-1';
                    } else {
                        previewNotes.innerHTML = '<em class="text-muted">Sin notas...</em>';
                        previewNotes.className = 'bg-light p-2 rounded mt-1';
                    }
                }
            });
        }

        if (isCurrentInput) {
            isCurrentInput.addEventListener('change', function () {
                const badge = document.getElementById('previewBadge');
                if (badge) {
                    if (this.checked) {
                        badge.textContent = 'Actual';
                        badge.className = 'badge bg-success ms-2';
                    } else {
                        badge.textContent = 'Archivada';
                        badge.className = 'badge bg-secondary ms-2';
                    }
                }
            });
        }

        // Form submission
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                submitLauncher();
            });
        }

        // Update submit button on input changes
        document.addEventListener('input', function (e) {
            if (e.target.id === 'version') {
                updateSubmitButton();
            }
        });

        console.log('Inicializaci√≥n completada');
    });

    // FUNCI√ìN CORREGIDA - Esta es la que causaba el error
    // REEMPLAZA LA FUNCI√ìN handleFileSelection COMPLETA:
    function handleFileSelection(file) {
        console.log('handleFileSelection llamada con archivo:', file.name);

        if (!file.name.toLowerCase().endsWith('.exe')) {
            alert('Solo se permiten archivos ejecutables (.exe)');
            return;
        }

        selectedFile = file;
        const finalName = 'LC.exe';

        // üîç DEBUG: Verificar que los elementos existen
        const fileNameEl = document.getElementById('fileName');
        const fileSizeEl = document.getElementById('fileSize');
        const finalFileNameEl = document.getElementById('finalFileName');
        const fileInfoEl = document.getElementById('fileInfo');
        const previewFileNameEl = document.getElementById('previewFileName');

        console.log('üîç Elementos encontrados:', {
            fileName: !!fileNameEl,
            fileSize: !!fileSizeEl,
            finalFileName: !!finalFileNameEl,
            fileInfo: !!fileInfoEl,
            previewFileName: !!previewFileNameEl
        });

        // Solo actualizar elementos que existen
        if (fileNameEl) {
            fileNameEl.textContent = file.name;
            console.log('‚úÖ fileName actualizado:', file.name);
        } else {
            console.error('‚ùå fileName element not found');
        }

        if (fileSizeEl) {
            fileSizeEl.textContent = formatFileSize(file.size);
            console.log('‚úÖ fileSize actualizado:', formatFileSize(file.size));
        } else {
            console.error('‚ùå fileSize element not found');
        }

        if (finalFileNameEl) {
            finalFileNameEl.textContent = finalName;
            console.log('‚úÖ finalFileName actualizado:', finalName);
        } else {
            console.error('‚ùå finalFileName element not found');
        }

        if (fileInfoEl) {
            // üéØ FORZAR la visualizaci√≥n
            fileInfoEl.style.display = 'block';
            fileInfoEl.style.visibility = 'visible';
            //fileInfoEl.style.opacity = '1';

            // üéØ ASEGURAR que no hay CSS que lo oculte
            fileInfoEl.classList.remove('d-none');
            fileInfoEl.removeAttribute('hidden');

            console.log('‚úÖ fileInfo forzado a mostrarse');
        } else {
            console.error('‚ùå Element fileInfo not found in DOM');

            // üö® CREAR el elemento si no existe (fallback)
            const uploadCard = document.querySelector('.card-body');
            if (uploadCard) {
                const newFileInfo = document.createElement('div');
                newFileInfo.id = 'fileInfo';
                newFileInfo.className = 'mt-4';
                newFileInfo.innerHTML = `
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle me-3"></i>
                    <div class="flex-grow-1">
                        <strong id="fileName">${file.name}</strong><br>
                        <small id="fileSize">${formatFileSize(file.size)}</small>
                        <div class="mt-2">
                            <strong>Nombre final:</strong> <code id="finalFileName">${finalName}</code>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFile()">
                        <i class="bi bi-x"></i> Cambiar
                    </button>
                </div>
            </div>
        `;
                uploadCard.appendChild(newFileInfo);
                console.log('üì¶ fileInfo creado din√°micamente');
            }
        }

        // Update preview
        if (previewFileNameEl) {
            previewFileNameEl.textContent = finalName;
            console.log('‚úÖ previewFileName actualizado:', finalName);
        } else {
            console.error('‚ùå previewFileName element not found');
        }

        updateSubmitButton();
        console.log('handleFileSelection completado exitosamente');
    }

    function clearFile() {
        console.log('üóëÔ∏è clearFile llamada');

        selectedFile = null;

        const fileInput = document.getElementById('launcherFile');
        const fileInfo = document.getElementById('fileInfo');
        const uploadArea = document.getElementById('uploadArea');

        if (fileInput) {
            fileInput.value = '';
        }

        if (fileInfo) {
            fileInfo.style.display = 'none';
        }

        // üéØ RESTAURAR EL √ÅREA DE UPLOAD COMPLETAMENTE:
        if (uploadArea) {
            uploadArea.classList.remove('file-selected');
            uploadArea.style.padding = '3rem 2rem'; // Restaurar padding original

            const uploadContent = uploadArea.querySelector('.upload-content');
            if (uploadContent) {
                uploadContent.innerHTML = `
                <i class="bi bi-app" style="font-size: 3rem; color: #6c757d;"></i>
                <h5 class="mt-3 mb-2">Arrastra el ejecutable aqu√≠ o haz clic para seleccionar</h5>
                <p class="text-muted mb-3">
                    Solo archivos .exe son permitidos<br>
                    El archivo ser√° renombrado autom√°ticamente si es necesario
                </p>
                <button type="button" class="btn btn-primary">
                    <i class="bi bi-folder2-open me-2"></i>Seleccionar Ejecutable
                </button>
            `;
            }

            // Reconfigurar eventos despu√©s de restaurar
            setupUploadAreaEvents();
        }

        updatePreviewFileName('Launcher.exe');
        updateSubmitButton();
    }

    function setupUploadAreaEvents() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('launcherFile');

        if (uploadArea && fileInput) {
            // Configurar click en √°rea
            uploadArea.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                e.preventDefault();
                fileInput.click();
            });

            // Configurar bot√≥n espec√≠ficamente
            const selectButton = uploadArea.querySelector('.btn-primary');
            if (selectButton) {
                selectButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    fileInput.click();
                });
            }
        }
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submitBtn');
        const versionInput = document.getElementById('version');

        if (!submitBtn) {
            console.warn('Submit button no encontrado');
            return;
        }

        const hasFile = selectedFile !== null;
        const hasVersion = versionInput ? versionInput.value.trim() !== '' : false;
        const validVersion = versionInput ? /^\d+\.\d+\.\d+\.\d+$/.test(versionInput.value.trim()) : false;

        const shouldEnable = hasFile && hasVersion && validVersion;
        submitBtn.disabled = !shouldEnable;

        console.log('Submit button actualizado:', {
            hasFile,
            hasVersion,
            validVersion,
            disabled: submitBtn.disabled
        });
    }

    async function loadCurrentVersionInfo() {
        console.log('Cargando informaci√≥n de versi√≥n actual...');

        const currentVersionInfo = document.getElementById('currentVersionInfo');
        if (!currentVersionInfo) {
            console.error('Elemento currentVersionInfo no encontrado');
            return;
        }

        try {
            const response = await fetch('/api/launcher_update');
            const data = await response();

            currentVersionInfo.innerHTML = `
                <div class="text-center">
                    <h6 class="text-success mb-2">${data.version}</h6>
                    <p class="mb-2"><code>${data.file_name}</code></p>
                    <small class="text-muted">En producci√≥n</small>
                </div>
                <hr>
                <div class="d-grid">
                    <a href="/Launcher/${data.file_name}" class="btn btn-outline-primary btn-sm" target="_blank">
                        <i class="bi bi-download me-1"></i>Descargar Actual
                    </a>
                </div>
            `;
            console.log('‚úÖ Informaci√≥n de versi√≥n actual cargada');
        } catch (error) {
            console.warn('No se pudo cargar la versi√≥n actual:', error);
            currentVersionInfo.innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    <br>
                    <small>No hay versi√≥n actual</small>
                </div>
            `;
        }
    }

    async function submitLauncher() {
        console.log('submitLauncher llamada');

        if (!selectedFile) {
            alert('Selecciona un archivo ejecutable');
            return;
        }

        const versionInput = document.getElementById('version');
        const version = versionInput ? versionInput.value.trim() : '';

        if (!version || !/^\d+\.\d+\.\d+\.\d+$/.test(version)) {
            alert('Ingresa una versi√≥n v√°lida (formato: 1.0.0.0)');
            if (versionInput) versionInput.focus();
            return;
        }

        // Show progress
        const progressCard = document.getElementById('progressCard');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadSteps = document.getElementById('uploadSteps');
        const submitBtn = document.getElementById('submitBtn');

        if (progressCard) progressCard.style.display = 'block';
        if (submitBtn) submitBtn.disabled = true;

        // Show loading on button
        const btnText = submitBtn ? submitBtn.querySelector('.btn-text') : null;
        const spinner = submitBtn ? submitBtn.querySelector('.spinner-border') : null;

        if (btnText) btnText.innerHTML = '<i class="bi bi-hourglass"></i> Procesando...';
        if (spinner) spinner.classList.remove('d-none');

        try {
            const formData = new FormData();
            formData.append('version', version);
            formData.append('launcher_file', selectedFile);

            // Agregar otros campos del formulario solo si existen
            const releaseNotesEl = document.getElementById('release_notes');
            const isCurrentEl = document.getElementById('is_current');
            const replaceExistingEl = document.getElementById('replaceExisting');
            const createBackupEl = document.getElementById('createBackup');
            const updateJSONEl = document.getElementById('updateJSON');
            const notifyClientsEl = document.getElementById('notifyClients');

            if (releaseNotesEl) formData.append('release_notes', releaseNotesEl.value);
            if (isCurrentEl) formData.append('is_current', isCurrentEl.checked);
            if (replaceExistingEl) formData.append('replace_existing', replaceExistingEl.checked);
            if (createBackupEl) formData.append('create_backup', createBackupEl.checked);
            if (updateJSONEl) formData.append('update_json', updateJSONEl.checked);
            if (notifyClientsEl) formData.append('notify_clients', notifyClientsEl.checked);

            // Simulate upload steps
            const steps = [
                'Validando archivo...',
                'Creando backup de versi√≥n actual...',
                'Subiendo nuevo launcher...',
                'Actualizando metadatos...',
                'Regenerando JSON de configuraci√≥n...',
                'Finalizando...'
            ];

            let progress = 0;
            let stepIndex = 0;

            const progressInterval = setInterval(() => {
                if (stepIndex < steps.length && uploadStatus && uploadSteps) {
                    uploadStatus.textContent = steps[stepIndex];
                    uploadSteps.innerHTML = steps.slice(0, stepIndex + 1)
                        .map((step, i) => `<div>${i === stepIndex ? 'üîÑ' : '‚úÖ'} ${step}</div>`)
                        .join('');
                    stepIndex++;
                }

                progress += Math.random() * 15;
                if (progress > 90) progress = 90;

                if (uploadProgress) {
                    uploadProgress.style.width = `${progress}%`;
                    uploadProgress.textContent = `${Math.round(progress)}%`;
                }
            }, 1000);

            // Submit form
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });

            clearInterval(progressInterval);

            if (response.ok) {
                // Complete progress
                if (uploadProgress) {
                    uploadProgress.style.width = '100%';
                    uploadProgress.textContent = '100%';
                }
                if (uploadStatus) {
                    uploadStatus.innerHTML = '<i class="bi bi-check-circle text-success me-2"></i>¬°Launcher subido exitosamente!';
                }
                if (uploadSteps) {
                    uploadSteps.innerHTML = steps.map(step => `<div>‚úÖ ${step}</div>`).join('');
                }

                setTimeout(() => {
                    window.location.href = '{{ url_for("admin.launcher_versions") }}';
                }, 2000);
            } else {
                throw new Error(`Error del servidor: ${response.status}`);
            }

        } catch (error) {
            console.error('Error en submitLauncher:', error);

            if (uploadProgress) {
                uploadProgress.classList.remove('progress-bar-animated');
                uploadProgress.classList.add('bg-danger');
            }
            if (uploadStatus) {
                uploadStatus.innerHTML = `<i class="bi bi-exclamation-triangle text-danger me-2"></i>Error: ${error.message}`;
            }
            if (uploadSteps) {
                uploadSteps.innerHTML = '<div class="text-danger">‚ùå La subida ha fallado</div>';
            }

            // Restore button
            if (btnText) btnText.innerHTML = '<i class="bi bi-cloud-upload"></i> Subir Launcher';
            if (spinner) spinner.classList.add('d-none');
            if (submitBtn) submitBtn.disabled = false;
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';

        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
</script>
{% endblock %}