{% extends "base.html" %}

{% block title %}Subir Archivos - Launcher Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-cloud-upload me-2"></i>Subir Archivos del Juego
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin.files') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver a Archivos
        </a>
    </div>
</div>

<form method="POST" enctype="multipart/form-data" id="uploadForm">
    <div class="row">
        <div class="col-lg-8">
            <!-- Version Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-tag me-2"></i>Seleccionar Versión
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <select class="form-select" name="version_id" id="versionSelect" required>
                                <option value="">Selecciona una versión...</option>
                                {% for version in versions %}
                                <option value="{{ version.id }}" {% if version.is_latest %}selected{% endif %}>
                                    {{ version.version }}
                                    {% if version.is_latest %}- Versión Actual{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.create_version') }}" class="btn btn-outline-primary w-100">
                                <i class="bi bi-plus-circle me-1"></i>Nueva Versión
                            </a>
                        </div>
                    </div>
                    {% if not versions %}
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No hay versiones disponibles. 
                        <a href="{{ url_for('admin.create_version') }}" class="alert-link">Crea una versión</a> 
                        antes de subir archivos.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- File Upload Area -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-files me-2"></i>Seleccionar Archivos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="file-upload-area" id="uploadArea">
                        <div class="upload-content">
                            <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>
                            <h5 class="mt-3 mb-2">Arrastra archivos aquí o haz clic para seleccionar</h5>
                            <p class="text-muted mb-3">
                                Puedes subir múltiples archivos a la vez<br>
                                Formatos soportados: .exe, .dll, .txt, .xml, , .png, .jpg, .gif
                            </p>
                            <button type="button" class="btn btn-primary">
                                <i class="bi bi-folder2-open me-2"></i>Examinar Archivos
                            </button>
                        </div>
                        <input type="file" 
                               id="fileInput" 
                               name="files" 
                               multiple 
                               accept=".exe,.dll,.txt,.xml,,.png,.jpg,.gif"
                               style="display: none;">
                    </div>
                    
                    <!-- File List -->
                    <div id="fileList" class="mt-4" style="display: none;">
                        <h6 class="fw-bold mb-3">Archivos Seleccionados:</h6>
                        <div id="selectedFiles"></div>
                    </div>
                </div>
            </div>

            <!-- Upload Progress -->
            <div class="card mb-4" id="progressCard" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-hourglass-split me-2"></i>Progreso de Subida
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="uploadProgress" 
                             style="width: 0%">0%</div>
                    </div>
                    <div id="uploadStatus" class="text-muted">
                        Preparando subida...
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{{ url_for('admin.files') }}" class="btn btn-outline-secondary me-md-2">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    <span class="btn-text">
                        <i class="bi bi-cloud-upload"></i> Subir Archivos
                    </span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Upload Guidelines -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Directrices de Subida
                    </h6>
                </div>
                <div class="card-body">
                    <div class="upload-guidelines">
                        <h6 class="fw-bold">Formatos Soportados:</h6>
                        <ul class="list-unstyled mb-3">
                            <li><i class="bi bi-check text-success me-2"></i>Ejecutables (.exe)</li>
                            <li><i class="bi bi-check text-success me-2"></i>Librerías (.dll)</li>
                            <li><i class="bi bi-check text-success me-2"></i>Configuración (.xml, )</li>
                            <li><i class="bi bi-check text-success me-2"></i>Texto (.txt)</li>
                            <li><i class="bi bi-check text-success me-2"></i>Imágenes (.png, .jpg, .gif)</li>
                        </ul>

                        <h6 class="fw-bold">Límites:</h6>
                        <ul class="list-unstyled mb-3">
                            <li><i class="bi bi-info-circle text-info me-2"></i>Tamaño máximo: 500 MB total</li>
                            <li><i class="bi bi-info-circle text-info me-2"></i>Archivos simultáneos: ilimitados</li>
                        </ul>

                        <h6 class="fw-bold">Comportamiento:</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-arrow-repeat text-warning me-2"></i>Archivos existentes serán reemplazados</li>
                            <li><i class="bi bi-shield-check text-success me-2"></i>Se calculará MD5 automáticamente</li>
                            <li><i class="bi bi-folder text-primary me-2"></i>Ruta por defecto: bin/</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Path Configuration -->
            <div class="card mb-4" id="pathCard" style="display: none;">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-folder me-2"></i>Configuración de Rutas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Consejo:</strong> Puedes personalizar la ruta relativa de cada archivo después de seleccionarlos.
                    </div>
                    <div id="pathInputs">
                        <!-- Dynamic path inputs will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Version Info -->
            <div class="card" id="versionInfo" style="display: none;">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-tag me-2"></i>Información de la Versión
                    </h6>
                </div>
                <div class="card-body" id="versionDetails">
                    <!-- Version details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
    let selectedFiles = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const versionSelect = document.getElementById('versionSelect');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('uploadForm');
        
        // File upload area events
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            handleFileSelection(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFileSelection(files);
        });
        
        // Version selection change
        versionSelect.addEventListener('change', function() {
            if (this.value) {
                loadVersionInfo(this.value);
                updateSubmitButton();
            } else {
                document.getElementById('versionInfo').style.display = 'none';
                updateSubmitButton();
            }
        });
        
        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            submitFiles();
        });
        
        // Load initial version info if there's a selected version
        if (versionSelect.value) {
            loadVersionInfo(versionSelect.value);
        }
    });
    
    function handleFileSelection(files) {
        selectedFiles = files.filter(file => {
            const allowedTypes = ['.exe', '.dll', '.txt', '.xml', '', '.png', '.jpg', '.gif'];
            const fileExt = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            return allowedTypes.includes(fileExt);
        });
        
        if (selectedFiles.length === 0) {
            alert('No se seleccionaron archivos válidos. Revisa los formatos soportados.');
            return;
        }
        
        displaySelectedFiles();
        generatePathInputs();
        updateSubmitButton();
    }
    
    function displaySelectedFiles() {
        const fileList = document.getElementById('fileList');
        const selectedFilesDiv = document.getElementById('selectedFiles');
        
        if (selectedFiles.length === 0) {
            fileList.style.display = 'none';
            return;
        }
        
        fileList.style.display = 'block';
        
        let html = '';
        let totalSize = 0;
        
        selectedFiles.forEach((file, index) => {
            totalSize += file.size;
            const fileSize = formatFileSize(file.size);
            const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            
            html += `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                ${getFileIcon(fileExt)}
                            </div>
                            <div class="col">
                                <div class="fw-bold">${file.name}</div>
                                <small class="text-muted">${fileSize} • ${fileExt}</small>
                            </div>
                            <div class="col-auto">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
            <div class="alert alert-info mt-3">
                <i class="bi bi-info-circle me-2"></i>
                <strong>${selectedFiles.length} archivo(s) seleccionado(s)</strong> • 
                Tamaño total: ${formatFileSize(totalSize)}
            </div>
        `;
        
        selectedFilesDiv.innerHTML = html;
    }
    
    function generatePathInputs() {
        const pathCard = document.getElementById('pathCard');
        const pathInputs = document.getElementById('pathInputs');
        
        if (selectedFiles.length === 0) {
            pathCard.style.display = 'none';
            return;
        }
        
        pathCard.style.display = 'block';
        
        let html = '';
        selectedFiles.forEach((file, index) => {
            const defaultPath = `bin/${file.name}`;
            html += `
                <div class="mb-3">
                    <label class="form-label small fw-bold">${file.name}</label>
                    <input type="text" 
                           class="form-control form-control-sm" 
                           name="relative_path_${file.name}" 
                           value="${defaultPath}"
                           placeholder="Ruta relativa del archivo">
                </div>
            `;
        });
        
        pathInputs.innerHTML = html;
    }
    
    function removeFile(index) {
        selectedFiles.splice(index, 1);
        
        // Update file input
        const fileInput = document.getElementById('fileInput');
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
        
        displaySelectedFiles();
        generatePathInputs();
        updateSubmitButton();
    }
    
    function loadVersionInfo(versionId) {
        const versionInfo = document.getElementById('versionInfo');
        const versionDetails = document.getElementById('versionDetails');
        
        // Mock version info loading (replace with actual AJAX call)
        const versions = JSON.parse('{{ versions_data | tojson | safe }}');
        const version = versions.find(v => v.id == versionId);
        
        if (version) {
            versionInfo.style.display = 'block';
            versionDetails.innerHTML = `
                <dl class="row mb-0">
                    <dt class="col-sm-6">Versión:</dt>
                    <dd class="col-sm-6">
                        <span class="badge ${version.is_latest ? 'bg-success' : 'bg-secondary'}">${version.version}</span>
                    </dd>
                    <dt class="col-sm-6">Estado:</dt>
                    <dd class="col-sm-6">${version.is_latest ? 'Actual' : 'Archivada'}</dd>
                    <dt class="col-sm-6">Archivos:</dt>
                    <dd class="col-sm-6">${version.files ? version.files.length : 0}</dd>
                </dl>
            `;
        }
    }
    
    function updateSubmitButton() {
        const submitBtn = document.getElementById('submitBtn');
        const versionSelect = document.getElementById('versionSelect');
        
        const hasFiles = selectedFiles.length > 0;
        const hasVersion = versionSelect.value !== '';
        
        submitBtn.disabled = !(hasFiles && hasVersion);
    }
    
    async function submitFiles() {
        if (selectedFiles.length === 0) {
            alert('No hay archivos seleccionados');
            return;
        }
        
        const versionId = document.getElementById('versionSelect').value;
        if (!versionId) {
            alert('Selecciona una versión');
            return;
        }
        
        // Show progress card
        const progressCard = document.getElementById('progressCard');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadStatus = document.getElementById('uploadStatus');
        const submitBtn = document.getElementById('submitBtn');
        
        progressCard.style.display = 'block';
        submitBtn.disabled = true;
        
        try {
            const formData = new FormData();
            formData.append('version_id', versionId);
            
            // Add files to form data
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });
            
            // Add relative paths
            selectedFiles.forEach(file => {
                const pathInput = document.querySelector(`input[name="relative_path_${file.name}"]`);
                if (pathInput) {
                    formData.append(`relative_path_${file.name}`, pathInput.value);
                }
            });
            
            // Simulate upload progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                
                uploadProgress.style.width = `${progress}%`;
                uploadProgress.textContent = `${Math.round(progress)}%`;
                uploadStatus.textContent = `Subiendo archivos... ${Math.round(progress)}%`;
            }, 200);
            
            // Submit form
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });
            
            clearInterval(progressInterval);
            
            if (response.ok) {
                uploadProgress.style.width = '100%';
                uploadProgress.textContent = '100%';
                uploadStatus.innerHTML = '<i class="bi bi-check-circle text-success me-2"></i>¡Archivos subidos exitosamente!';
                
                setTimeout(() => {
                    window.location.href = '{{ url_for("admin.files") }}';
                }, 1500);
            } else {
                throw new Error('Error en la respuesta del servidor');
            }
            
        } catch (error) {
            uploadProgress.classList.add('bg-danger');
            uploadStatus.innerHTML = `<i class="bi bi-exclamation-triangle text-danger me-2"></i>Error: ${error.message}`;
            submitBtn.disabled = false;
        }
    }
    
    function getFileIcon(extension) {
        const icons = {
            '.exe': '<i class="bi bi-app text-primary"></i>',
            '.dll': '<i class="bi bi-gear text-secondary"></i>',
            '.xml': '<i class="bi bi-code text-info"></i>',
            '': '<i class="bi bi-code text-info"></i>',
            '.txt': '<i class="bi bi-file-text text-success"></i>',
            '.png': '<i class="bi bi-image text-warning"></i>',
            '.jpg': '<i class="bi bi-image text-warning"></i>',
            '.gif': '<i class="bi bi-image text-warning"></i>'
        };
        
        return icons[extension] || '<i class="bi bi-file-earmark text-muted"></i>';
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
</script>
{% endblock %}