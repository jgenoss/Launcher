/**
 * dashboard.js - L√≥gica Vue.js para el Dashboard
 * Separado completamente del template Jinja2
 */

// Esperar a que el DOM est√© completamente cargado
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOMContentLoaded - Iniciando Dashboard Vue.js');
    
    // Verificar que Vue est√© disponible
    if (typeof Vue === 'undefined') {
        console.error('‚ùå Vue.js no est√° disponible');
        return;
    }
    console.log('‚úÖ Vue.js disponible');
    
    // Verificar que el elemento #app existe
    const appElement = document.getElementById('app');
    if (!appElement) {
        console.error('‚ùå Elemento #app no encontrado en el DOM');
        return;
    }
    console.log('‚úÖ Elemento #app encontrado');
    
    // Verificar que los datos del servidor est√©n disponibles
    if (typeof window.DASHBOARD_DATA === 'undefined') {
        console.error('‚ùå DASHBOARD_DATA no est√° disponible');
        window.DASHBOARD_DATA = {
            stats: {
                totalVersions: 0,
                totalFiles: 0,
                totalUpdates: 0,
                totalDownloads: 0,
                recentDownloads: 0,
                activeMessages: 0,
                latestVersion: ''
            },
            systemStatus: {
                gameVersion: '',
                launcherVersion: ''
            },
            chartData: []
        };
    } else {
        console.log('‚úÖ DASHBOARD_DATA disponible:', window.DASHBOARD_DATA);
    }
    
    // Verificar que los mixins est√©n disponibles
    if (typeof NotificationMixin === 'undefined') {
        console.error('‚ùå NotificationMixin no est√° disponible');
        return;
    }
    console.log('‚úÖ Mixins disponibles');

    // Configurar delimitadores de Vue ANTES de crear la instancia
    Vue.config.delimiters = ['[[', ']]'];
    console.log('‚úÖ Delimitadores Vue configurados: [[, ]]');
    
    console.log('üîß Creando instancia Vue...');

    // Crear instancia Vue para el Dashboard
    const dashboardApp = new Vue({
        el: '#app',
        delimiters: ['[[', ']]'], // Configurar delimitadores espec√≠ficamente para esta instancia
        mixins: [NotificationMixin, HttpMixin, UtilsMixin, SocketMixin],
        data() {
            return {
                // Estados reactivos inicializados con datos del servidor
                stats: {
                    totalVersions: window.DASHBOARD_DATA.stats.totalVersions || 0,
                    totalFiles: window.DASHBOARD_DATA.stats.totalFiles || 0,
                    totalUpdates: window.DASHBOARD_DATA.stats.totalUpdates || 0,
                    totalDownloads: window.DASHBOARD_DATA.stats.totalDownloads || 0,
                    recentDownloads: window.DASHBOARD_DATA.stats.recentDownloads || 0,
                    activeMessages: window.DASHBOARD_DATA.stats.activeMessages || 0,
                    latestVersion: window.DASHBOARD_DATA.stats.latestVersion || ''
                },
                systemStatus: {
                    gameVersion: window.DASHBOARD_DATA.systemStatus.gameVersion || '',
                    launcherVersion: window.DASHBOARD_DATA.systemStatus.launcherVersion || ''
                },
                apiStatus: {
                    online: true
                },
                recentActivity: {
                    downloadsByType: [],
                    error: false
                },
                loadingActivity: false,
                loading: false,
                loadingMessage: 'Cargando...',
                chart: null,
                autoRefreshInterval: null,
                isSocketConnected: false,
                socket: null,
                // Datos del gr√°fico desde el servidor
                chartData: window.DASHBOARD_DATA.chartData || []
            };
        },

    
        mounted() {
            console.log('Vue mounted - Dashboard inicializado');
            console.log('Stats iniciales:', this.stats);
            console.log('System status inicial:', this.systemStatus);
            
            // Inicializar SocketIO
            this.initSocket();
            
            // Esperar un poco para que el DOM est√© completamente renderizado
            this.$nextTick(() => {
                this.initializeChart();
                this.checkApiStatus();
                this.loadRecentActivity();
            });
            
            // Auto-refresh cada 30 segundos
            this.autoRefreshInterval = setInterval(() => {
                this.checkApiStatus();
            }, 30000);
        },

    beforeDestroy() {
        if (this.autoRefreshInterval) {
            clearInterval(this.autoRefreshInterval);
        }
        if (this.chart) {
            this.chart.destroy();
        }
    },

    methods: {
        /**
         * Inicializar gr√°fico de descargas con Chart.js
         */
        initializeChart() {
            const ctx = document.getElementById('downloadsChart');
            if (!ctx) {
                console.warn('Canvas downloadsChart no encontrado - el gr√°fico se inicializar√° cuando est√© disponible');
                return;
            }

            const chartData = this.chartData;
            console.log('Inicializando gr√°fico con datos:', chartData);

            // Verificar que tengamos datos para el gr√°fico
            if (!chartData || chartData.length === 0) {
                console.warn('No hay datos para el gr√°fico');
                return;
            }

            this.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('es-ES', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric'
                        });
                    }),
                    datasets: [{
                        label: 'Descargas',
                        data: chartData.map(d => d.count),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 4,
                            hoverRadius: 6
                        }
                    }
                }
            });
        },

        /**
         * Verificar estado de la API
         */
        async checkApiStatus() {
            try {
                const data = await this.apiGet('/api/status');
                this.apiStatus.online = data.status === 'online';
                
                // Actualizar estad√≠sticas del sistema si est√°n disponibles
                if (data.latest_game_version) {
                    this.systemStatus.gameVersion = data.latest_game_version;
                }
                if (data.current_launcher_version) {
                    this.systemStatus.launcherVersion = data.current_launcher_version;
                }
                
                console.log('API Status verificado:', this.apiStatus.online);
            } catch (error) {
                this.apiStatus.online = false;
                console.error('Error checking API status:', error);
            }
        },

        /**
         * Cargar actividad reciente desde la API
         */
        async loadRecentActivity() {
            this.loadingActivity = true;
            this.recentActivity.error = false;
            
            try {
                const data = await this.apiGet('/api/stats');
                
                // Procesar datos de descargas por tipo
                this.recentActivity.downloadsByType = [];
                if (data.downloads_by_type) {
                    for (const [type, count] of Object.entries(data.downloads_by_type)) {
                        this.recentActivity.downloadsByType.push({
                            type: type,
                            count: count
                        });
                    }
                }
                
                console.log('Actividad reciente cargada:', this.recentActivity.downloadsByType);
            } catch (error) {
                this.recentActivity.error = true;
                console.error('Error loading recent activity:', error);
            } finally {
                this.loadingActivity = false;
            }
        },

        /**
         * Refrescar todas las estad√≠sticas manualmente
         */
        async refreshStats() {
            this.setLoading(true, 'Actualizando estad√≠sticas...');
            
            try {
                // Cargar estad√≠sticas del servidor
                const statsData = await this.apiGet('/api/stats');
                
                // Actualizar estad√≠sticas locales
                if (statsData) {
                    this.stats = {
                        ...this.stats,
                        totalDownloads: statsData.total_downloads || this.stats.totalDownloads,
                        activeMessages: statsData.active_messages || this.stats.activeMessages
                    };
                }
                
                // Verificar API y cargar actividad
                await Promise.all([
                    this.checkApiStatus(),
                    this.loadRecentActivity()
                ]);
                
                this.showSuccess('Actualizado', 'Estad√≠sticas actualizadas correctamente');
                console.log('Estad√≠sticas refrescadas manualmente');
            } catch (error) {
                this.showError('Error', 'No se pudieron actualizar las estad√≠sticas');
                console.error('Error refreshing stats:', error);
            } finally {
                this.setLoading(false);
            }
        },

        /**
         * Sobrescribir manejo de actualizaci√≥n de estad√≠sticas desde SocketIO
         * @param {Object} data - Datos de estad√≠sticas desde SocketIO
         */
        handleStatsUpdate(data) {
            console.log('Stats update from SocketIO:', data);
            
            // Actualizar estad√≠sticas en tiempo real
            if (data.total_downloads !== undefined) {
                this.stats.totalDownloads = data.total_downloads;
            }
            if (data.total_versions !== undefined) {
                this.stats.totalVersions = data.total_versions;
            }
            if (data.total_files !== undefined) {
                this.stats.totalFiles = data.total_files;
            }
            if (data.total_updates !== undefined) {
                this.stats.totalUpdates = data.total_updates;
            }
            if (data.active_messages !== undefined) {
                this.stats.activeMessages = data.active_messages;
            }
            if (data.latest_version) {
                this.stats.latestVersion = data.latest_version;
                this.systemStatus.gameVersion = data.latest_version;
            }
            
            // Mostrar notificaci√≥n de actualizaci√≥n en tiempo real
            this.showInfo('Actualizaci√≥n autom√°tica', 'Estad√≠sticas actualizadas en tiempo real');
        },

        /**
         * Manejar notificaciones espec√≠ficas del dashboard desde SocketIO
         * @param {Object} data - Datos de notificaci√≥n
         */
        handleSocketNotification(data) {
            // Llamar al m√©todo padre para manejo general
            SocketMixin.methods.handleSocketNotification.call(this, data);
            
            // Manejar notificaciones espec√≠ficas del dashboard
            if (data.data && data.data.action) {
                switch (data.data.action) {
                    case 'version_created':
                        this.stats.totalVersions++;
                        if (data.data.is_latest) {
                            this.systemStatus.gameVersion = data.data.version;
                            this.stats.latestVersion = data.data.version;
                        }
                        break;
                        
                    case 'files_uploaded':
                        this.stats.totalFiles += data.data.count || 1;
                        break;
                        
                    case 'update_created':
                        this.stats.totalUpdates++;
                        break;
                        
                    case 'message_created':
                        if (data.data.is_active) {
                            this.stats.activeMessages++;
                        }
                        break;
                        
                    case 'launcher_uploaded':
                        if (data.data.is_current) {
                            this.systemStatus.launcherVersion = data.data.version;
                        }
                        break;
                }
            }
        },

        /**
         * Actualizar gr√°fico con nuevos datos
         * @param {Array} newChartData - Nuevos datos para el gr√°fico
         */
        updateChart(newChartData) {
            if (!this.chart || !newChartData) return;
            
            this.chart.data.labels = newChartData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('es-ES', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
            });
            
            this.chart.data.datasets[0].data = newChartData.map(d => d.count);
            this.chart.update();
            
            console.log('Gr√°fico actualizado con nuevos datos');
        },

        /**
         * Obtener datos frescos del gr√°fico desde el servidor
         */
        async refreshChartData() {
            try {
                const response = await this.apiGet('/admin/dashboard-chart-data');
                if (response && response.downloads_by_day) {
                    this.chartData = response.downloads_by_day;
                    this.updateChart(this.chartData);
                }
            } catch (error) {
                console.error('Error refreshing chart data:', error);
            }
        },

        /**
         * Establecer estado de carga global
         * @param {Boolean} isLoading - Estado de carga
         * @param {String} message - Mensaje de carga
         */
        setLoading(isLoading, message = 'Cargando...') {
            this.loading = isLoading;
            this.loadingMessage = message;
        },

        /**
         * Probar conexi√≥n SocketIO
         */
        testSocketConnection() {
            if (this.isSocketConnected) {
                this.emitSocket('ping');
                this.showInfo('Test SocketIO', 'Ping enviado al servidor');
            } else {
                this.showWarning('Sin conexi√≥n', 'SocketIO no est√° conectado');
            }
        }
    },

    /**
     * Observadores para cambios de estado
     */
    watch: {
        // Observar cambios en el estado de conexi√≥n de la API
        'apiStatus.online'(newValue, oldValue) {
            if (newValue !== oldValue) {
                const status = newValue ? 'conectado' : 'desconectado';
                console.log(`API ${status}`);
                
                if (!newValue) {
                    this.showWarning('API Desconectada', 'La conexi√≥n con la API se ha perdido');
                } else if (oldValue === false) {
                    this.showSuccess('API Conectada', 'La conexi√≥n con la API se ha restablecido');
                }
            }
        },

        // Observar cambios en estad√≠sticas cr√≠ticas
        'stats.totalDownloads'(newValue, oldValue) {
            if (oldValue > 0 && newValue > oldValue) {
                console.log(`Nuevas descargas: ${newValue - oldValue}`);
            }
        }
    }
    });
    console.log('‚úÖ Instancia Vue creada:', dashboardApp);

    // Exponer la instancia para debugging (solo en desarrollo)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        window.dashboardApp = dashboardApp;
        console.log('Dashboard app disponible en window.dashboardApp para debugging');
    }

    console.log('Dashboard.js inicializado exitosamente');
});